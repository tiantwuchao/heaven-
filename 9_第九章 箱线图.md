### 箱线图

#### 什么是箱线图

**箱线图**也称箱须图、箱形图、盒图，用于反映一组或多组连续型定量数据分布的中心位置和散布范围。箱形图包含数学统计量，不仅能够分析不同类别数据各层次水平差异，**还能揭示数据间离散程度、异常值、分布差异等等。**

![image-20210517135153139](箱线图/image-20210517135153139.png)







**连续型数据**：在一定区间内可以任意取值的变量叫连续变量，其数值是连续不断的。例如，生产零件的规格尺寸，人体测量的身高、体重等，其数值只能用测量或计量的方法取得。可视化这类数据的图表主要有箱形图和直方图。



**离散型数据**：数值只能用自然数或整数单位计算的则为离散变量。例如，企业个数，职工人数，设备台数等，只能按计量单位数计数，数值一般用计数方法取得。大多数图表可视化的都是这类数据，比如柱状图、折线图等。



![image-20210517135300354](箱线图/image-20210517135300354.png)





在箱线图中，箱子的中间有一条线，代表了数据的中位数。**箱子的上下底，分别是数据的上四分位数（Q3）和下四分位数（Q1），这意味着箱体包含了50%的数据。因此，箱子的高度在一定程度上反映了数据的波动程度。上下边缘则代表了该组数据的最大值和最小值。有时候箱子外部会有一些点，可以理解为数据中的“异常值”。**

由于箱线图不像柱状图、折线图那样简单常见，许多人都对它敬而远之。但只要我们搞清楚了以下几个统计学的基本概念，箱线图也可以变得“平易近人”。



**四分位数**

一组数据按照从小到大顺序排列后，把该组数据四等分的数，称为四分位数。第一四分位数 (Q1)、第二四分位数 (Q2，也叫“**中位数**”)和第三四分位数 (Q3)分别等于该样本中所有数值由小到大排列后第25%、第50%和第75%的数字。第三四分位数与第一四分位数的差距又称四分位距（interquartile range, IQR）。



**偏度：**

- 对称分布：中位线在箱子中间，上下相邻值到箱子的距离等长，离群点在上下限值外的分布也大致相同。
- 右偏分布：**中位数更靠近下四分位数**，上相邻值到箱子的距离比下相邻值到箱子的距离长，离群点多数在上限值之外。
- 左偏分布：**中位数更靠近上四分位数**，下相邻值到箱子的距离比上相邻值到箱子的距离长，离群点多数在下限值之外





- ![f68e83ad008241f42e574676b957df98_1465325-20180910000602436-1679070053](箱线图/image-20210517140840087.png)

**偏度有什么意义**

它的类型是由概率分布尾巴所在的那一边来区分的

首先，线性模型假设自变量和目标变量的分布相似。因此，了解数据的偏度有助于我们创建更好的线性模型。

让我们看看下面的分布。它是汽车的马力分布：

![image-20210517152711928](箱线图/image-20210517152711928.png)

你可以清楚地看到上面的分布是正偏度的。现在，假设你想把这个作为模型的一个特性，它可以预测汽车的mpg（英里/加仑）。

因为我们的数据在这里是正偏度的，这意味着它有更多的低值数据点，也就是说，马力较小的汽车。

因此，当我们根据这些数据训练我们的模型时，它将在预测低马力汽车的mpg方面表现得比那些高马力的汽车更好。

另外，偏度告诉我们异常值的方向。你可以看到我们的分布是正偏度的，并且大多数异常值都出现在分布的右侧。

**注意：偏度并不能告诉我们异常值的数量。它只告诉我们方向。**







#### **箱线图独特的功能**



**直观明了地识别数据批中的异常值**

箱形图可以用来观察数据整体的分布情况，利用中位数，25/%分位数，75/%分位数，上边界，下边界等统计量来来描述数据的整体分布情况。通过计算这些统计量，生成一个箱体图，**箱体包含了大部分的正常数据**，而在箱体上边界和下边界之外的，就是异常数据。



**判断数据的偏态和尾重**

对于标准正态分布的大样本，中位数位于上下四分位数的中央，箱形图的方盒关于中位线对称。中位数越偏离上下四分位数的中心位置，分布偏态性越强。**异常值集中在较大值一侧，则分布呈现右偏态；******异常值集中在较小值一侧，则分布呈现左偏态。****



**比较多批数据的形状**

箱子的上下限，分别是数据的上四分位数和下四分位数。**这意味着箱子包含了50%的数据**。因此，箱子的宽度在一定程度上反映了数据的波动程度。**箱体越扁说明数据越集中，端线（也就是“须”）越短也说明数据集中。**



#### 案例1 : **职员薪酬分布**

下图是不同地区数据分析师的薪酬统计情况。

![image-20211027164954107](箱线图.assets/image-20211027164954107.png)





图中的红线显然是各个城市中游水平的数据分析师能够获得的薪资标准，上边的蓝线区间为中上游，下边的蓝线区间为中下游，以此类推。简而言之，样本人群被四等分了。

上海、北京、深圳的数据分析师，薪资范围接近，但是中上游水平的人，北京地区能获得更高的薪资，因为中位数（Q2）的位置更高。西安、长沙、天津则不利于数据分析师的发展。杭州的水平接近北上深，但是薪资上限受到一定限制。



#### **案例2：学生成绩分布**



![image-20211027165305716](箱线图.assets/image-20211027165305716.png)



图中我们可以看到学生的英语成绩相对其它科目普遍较好，而数学则大部分都出于80分以下。



有时候我们会发现箱形图的某一部分仿佛被隐藏了，比如下图的第一个箱子。

![image-20210517144552190](箱线图/image-20210517144552190.png)



除此之外还有一些极端情况，箱子被压得很扁，甚至只剩下一条线，同时还存在着很多异常值。这些情况的出现，有两个常见的原因。**第一**，样本数据中，存在特别大或者特别小的异常值，这种离群的表现，导致箱子整体被压缩，反而凸显出来这些异常；**第二**，样本数据特别少，因此箱体受单个数据的影响被放大了。



值得注意的是，**箱形图更多用于多组数据的比较**，相对直方图不仅节省了空间，还可以展示出许多直方图不能展示的信息。**单组数据则更适合采用直方图**，使可视化效果更加直观。



#### 代码实现1 :

###### 基础作图

```python
data = np.random.normal(0, 4, 100)  # 0 是均值 4 是标准差 ,100为个数 

fig = plt.figure(figsize=(8, 8))
ax1 = fig.add_subplot(221)
ax1.set_title('图1 常规作图')
ax1.boxplot(data)

muti_data = [np.random.normal(0, std, 100) for std in range(1, 4)]
ax2 = fig.add_subplot(222)
ax2.set_title('图2 多图绘制')
ax2.boxplot(muti_data)

ax3 = fig.add_subplot(223)
ax3.set_title('图3 水平箱线图')
ax3.boxplot(data, vert=False)  # 代表是水平

ax4 = fig.add_subplot(224)
ax4.set_title('图4 中间凹陷')
ax4.boxplot(data, notch=True)

plt.show()
```



![image-20210517144703697](箱线图/image-20210517144703697.png)







###### 修改标签

```python
data=np.random.normal(0,4,100)

fig = plt.figure(figsize=(8, 4))
muti_data=[np.random.normal(0,std,100) for std in range(1,4)]
ax2 = fig.add_subplot(121)
ax2.set_title('图1')
ax2.boxplot(muti_data, labels=['第1组', '第2组', '第3组'])

muti_data=[np.random.normal(0,std,100) for std in range(1,4)]
ax2 = fig.add_subplot(122)
ax2.set_title('图2')
ax2.boxplot(muti_data, vert=False, labels=['第1组', '第2组', '第3组'])

plt.show()
```



![image-20210517145603282](箱线图/image-20210517145603282.png)



###### 显示均值

```python
data=np.random.normal(0,4,100)

fig = plt.figure(figsize=(8, 4))
muti_data=[np.random.normal(0,std,100) for std in range(1,4)] # 太多分布
ax2 = fig.add_subplot(121)
ax2.set_title('图1')
ax2.boxplot(muti_data, labels=['第1组', '第2组', '第3组'], showmeans=True)  # 显示均值，默认以点的方式显示

muti_data=[np.random.normal(0,std,100) for std in range(1,4)]
ax2 = fig.add_subplot(122)
ax2.set_title('图2')
ax2.boxplot(muti_data, labels=['第1组', '第2组', '第3组'], showmeans=True, meanline=True)  # 显示均值，并以横线方式显示

plt.show()
```

![image-20210517145835062](箱线图/image-20210517145835062.png)





###### 箱体设置

```python
import numpy  as np
data=np.random.normal(0,4,100)

fig = plt.figure(figsize=(8, 4))
muti_data=[np.random.normal(0,std,100) for std in range(1,4)]
ax2 = plt.axes()
ax2.set_title('图1')
box_dict = ax2.boxplot(muti_data, labels=['第1组', '第2组', '第3组'],  patch_artist=True)  # 注意，patch_artist一定要设置为True，下面的设置才会生效

box_dict.get('boxes')[0].set_color('red')  # 箱体边框颜色
box_dict.get('boxes')[1].set_color('blue')
box_dict.get('boxes')[2].set_color('green')
plt.show()
```





![image-20210517143338128](箱线图/image-20210517143338128.png)







#### 代码实现2:

```python
import pandas as pd
import matplotlib.pyplot as plt 
plt.rcParams["font.sans-serif"] = "SimHei"
plt.rcParams["axes.unicode_minus"] = False   # 设置中文、负号正常显示
plt.style.use("ggplot")  #使用ggplot的图形style



train = pd.read_csv(r'C:\Users\1\Desktop\新数据分析讲义\第九章 散点图箱线图和饼图/titanic.csv')
train.age.isnull().any()  #检查年龄是否有缺失
train.dropna(inplace=True)  #删除含有缺失年龄的观测，即行  subset参数指定列名 




plt.figure(figsize=(5,6))
plt.boxplot(x = train.age,     # 绘图数据 
            notch = True,      #设置中位线处凹陷，（注意：下图看起来有点丑）
            patch_artist=True, # 设置用自定义颜色填充盒形图，默认白色填充 
            showmeans=True,    # 以点的形式显示均值 
            boxprops = {"color":"black","facecolor":"#F43D68"}, # 设置箱体属性，填充色and 边框色 
            flierprops = {"marker":"o","markerfacecolor":"#59EA3A","color":"#59EA3A"}, # 设置异常值属性，点的形状、填充色和边框色 
            meanprops = {"marker":"D","markerfacecolor":"white"}, # 设置均值点的属性，点的形状、填充色 
            medianprops = {"linestyle":"--","color":"#FBFE00"}         # 设置中位数线的属性，线的类型和颜色
            ) 

plt.title("乘客年龄箱线图",fontsize="xx-large",color="#DE0052")
plt.tick_params(top="off", right="off")  # 去掉o箱线图的上方及右方边框的刻度标签
plt.show()   # 显示图形，jupyter notebook有另一种写法，可以不用每一次画图都码这句
```

![image-20210517144212830](箱线图/image-20210517144212830.png)





乘客的平均年龄为30岁，有50%的人，年龄落在20~38岁之间(看箱体）；中位线偏下，上相邻值到箱子的距离比下相邻值到箱子的距离长，异常值多在上限值之外，说明年龄整体右偏；有偏大的异常值在64岁以上。













